<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Familial - Version Cloud</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .periode {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .periode select,
        .periode input {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            margin: 0 10px;
            width: 150px;
            text-align: center;
        }
        .periode select option {
            background: #4facfe;
            color: white;
        }
        .periode input::placeholder {
            color: rgba(255,255,255,0.8);
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .status.success {
            background: rgba(72, 187, 120, 0.2);
            border: 1px solid rgba(72, 187, 120, 0.5);
        }
        .status.error {
            background: rgba(229, 62, 62, 0.2);
            border: 1px solid rgba(229, 62, 62, 0.5);
        }
        .status.loading {
            background: rgba(66, 153, 225, 0.2);
            border: 1px solid rgba(66, 153, 225, 0.5);
        }
        .main-content {
            padding: 30px;
        }
        .section {
            margin-bottom: 40px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .section-header {
            padding: 20px;
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }
        .revenus { background: linear-gradient(135deg, #48bb78, #38a169); }
        .charges-fixes { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .charges-variables { background: linear-gradient(135deg, #9f7aea, #805ad5); }
        .bilan { background: linear-gradient(135deg, #4299e1, #3182ce); }
        .saisie-rapide { background: linear-gradient(135deg, #667eea, #764ba2); }
        .table-container {
            background: white;
        }
        .budget-table {
            width: 100%;
            border-collapse: collapse;
        }
        .budget-table th,
        .budget-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .budget-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        .montant-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
            text-align: right;
            transition: border-color 0.3s;
        }
        .montant-input:focus {
            outline: none;
            border-color: #4299e1;
        }
        .montant-display {
            text-align: right;
            font-weight: bold;
            font-family: monospace;
            font-size: 16px;
        }
        .pourcentage {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            border-radius: 5px;
            color: white;
        }
        .indicateur {
            text-align: center;
            font-size: 24px;
        }
        .vert {
            background: #48bb78;
        }
        .orange {
            background: #ed8936;
        }
        .rouge {
            background: #e53e3e;
        }
        .total-row {
            background: #edf2f7;
            font-weight: bold;
            font-size: 16px;
        }
        .solde-row {
            background: #e6fffa;
            font-weight: bold;
            font-size: 18px;
        }
        .solde-positif {
            color: #38a169;
        }
        .solde-negatif {
            color: #e53e3e;
        }
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }
        .alertes {
            margin-top: 30px;
            padding: 20px;
            background: #fff5f5;
            border-left: 4px solid #e53e3e;
            border-radius: 5px;
            display: none;
        }
        .alertes.show {
            display: block;
        }
        .alerte-item {
            margin: 10px 0;
            color: #c53030;
            font-weight: bold;
        }
        .legende {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legende-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f7fafc;
            border-radius: 20px;
        }
        .pastille {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .saisie-form {
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        .saisie-form select,
        .saisie-form input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        .saisie-form select {
            min-width: 200px;
        }
        .saisie-form input {
            width: 120px;
            text-align: right;
        }
        .btn-ajouter {
            padding: 12px 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-ajouter:hover {
            transform: translateY(-2px);
        }
        .message-rapide {
            width: 100%;
            text-align: center;
            color: #38a169;
            font-weight: bold;
            min-height: 20px;
            padding: 10px;
        }
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            .header {
                padding: 20px;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .periode {
                padding: 10px;
            }
            .periode select,
            .periode input {
                width: 120px;
                margin: 5px;
                font-size: 14px;
                padding: 8px;
            }
            .btn {
                padding: 10px 15px;
                margin: 5px;
                font-size: 14px;
            }
            .saisie-form {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .saisie-form select {
                min-width: 100%;
            }
            .saisie-form input {
                width: 100%;
            }
            .budget-table {
                font-size: 12px;
            }
            .budget-table th,
            .budget-table td {
                padding: 8px 4px;
                word-wrap: break-word;
            }
            .budget-table th:first-child,
            .budget-table td:first-child {
                width: 50%;
                font-size: 11px;
            }
            .budget-table th:not(:first-child),
            .budget-table td:not(:first-child) {
                width: 12.5%;
            }
            .montant-input {
                padding: 4px;
                font-size: 12px;
            }
            .montant-display {
                font-size: 12px;
            }
            .pourcentage {
                font-size: 11px;
                padding: 4px;
            }
            .indicateur {
                font-size: 18px;
            }
            .legende {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .legende-item {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Budget Familial - Version Cloud</h1>
            <div class="periode">
                <select id="mois">
                    <option value="">Sélectionner un mois</option>
                    <option value="Janvier">Janvier</option>
                    <option value="Février">Février</option>
                    <option value="Mars">Mars</option>
                    <option value="Avril">Avril</option>
                    <option value="Mai">Mai</option>
                    <option value="Juin">Juin</option>
                    <option value="Juillet">Juillet</option>
                    <option value="Août">Août</option>
                    <option value="Septembre">Septembre</option>
                    <option value="Octobre">Octobre</option>
                    <option value="Novembre">Novembre</option>
                    <option value="Décembre">Décembre</option>
                </select>
                <input type="number" id="annee" min="2024" max="2030">
                <button class="btn" onclick="sauvegarderCloud()" id="btn-sauv">Sauvegarder</button>
                <button class="btn" onclick="chargerCloud()" id="btn-load">Charger</button>
                <button class="btn btn-danger" onclick="reset()">Reset</button>
                <div class="status" id="status" style="display: none;"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="legende">
                <div class="legende-item">
                    <div class="pastille vert"></div>
                    <span>Budget respecté (&lt;100%)</span>
                </div>
                <div class="legende-item">
                    <div class="pastille orange"></div>
                    <span>Attention (100-110%)</span>
                </div>
                <div class="legende-item">
                    <div class="pastille rouge"></div>
                    <span>Dépassement (&gt;110%)</span>
                </div>
            </div>

            <!-- SAISIE RAPIDE -->
            <div class="section">
                <div class="section-header saisie-rapide">Saisie Rapide</div>
                <div class="table-container">
                    <div class="saisie-form">
                        <select id="categorie-rapide">
                            <option value="">Choisir une catégorie</option>
                            <option value="logement">Logement</option>
                            <option value="energie">Énergie</option>
                            <option value="telephonie">Téléphonie/Internet</option>
                            <option value="banque">Banque/Impôts</option>
                            <option value="scolaire">Scolaire</option>
                            <option value="sports">Sports/Loisirs enfants</option>
                            <option value="sante">Santé courante</option>
                            <option value="transport-abo">Transport abonnements</option>
                            <option value="alimentation">Alimentation maison</option>
                            <option value="resto">Resto/Take away</option>
                            <option value="transport">Transport ponctuel</option>
                            <option value="consommation">Consommation/Plaisir</option>
                            <option value="vacances">Provision vacances</option>
                            <option value="travaux">Provision travaux/imprevus</option>
                        </select>
                        <input type="number" id="montant-rapide" placeholder="Montant €" step="0.01">
                        <button class="btn-ajouter" onclick="ajouterDepense()">Ajouter</button>
                        <div id="message-rapide" class="message-rapide"></div>
                    </div>
                </div>
            </div>

            <!-- REVENUS -->
            <div class="section">
                <div class="section-header revenus">Revenus</div>
                <div class="table-container">
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Catégorie</th>
                                <th style="width: 15%;">Budget</th>
                                <th style="width: 15%;">Réalisé</th>
                                <th style="width: 15%;">Écart</th>
                                <th style="width: 10%;">%</th>
                                <th style="width: 5%;">📊</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Salaire Marie</td>
                                <td class="montant-display">2 500€</td>
                                <td><input type="number" class="montant-input" data-budget="2500" data-category="revenus" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Salaire Etienne</td>
                                <td class="montant-display">1 500€</td>
                                <td><input type="number" class="montant-input" data-budget="1500" data-category="revenus" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>CAF</td>
                                <td class="montant-display">400€</td>
                                <td><input type="number" class="montant-input" data-budget="400" data-category="revenus" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL REVENUS</strong></td>
                                <td class="montant-display"><strong>4 400€</strong></td>
                                <td class="montant-display" id="total-revenus-realise"><strong>0€</strong></td>
                                <td class="montant-display" id="total-revenus-ecart"><strong>0€</strong></td>
                                <td class="pourcentage" id="total-revenus-pct"><strong>0%</strong></td>
                                <td class="indicateur" id="total-revenus-indicateur">⚪</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CHARGES FIXES -->
            <div class="section">
                <div class="section-header charges-fixes">Charges fixes</div>
                <div class="table-container">
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Catégorie</th>
                                <th style="width: 15%;">Budget</th>
                                <th style="width: 15%;">Réalisé</th>
                                <th style="width: 15%;">Écart</th>
                                <th style="width: 10%;">%</th>
                                <th style="width: 5%;">📊</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Logement complet</td>
                                <td class="montant-display">1 200€</td>
                                <td><input type="number" class="montant-input" data-budget="1200" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Énergie</td>
                                <td class="montant-display">180€</td>
                                <td><input type="number" class="montant-input" data-budget="180" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Téléphonie/Internet</td>
                                <td class="montant-display">160€</td>
                                <td><input type="number" class="montant-input" data-budget="160" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Banque/Impôts</td>
                                <td class="montant-display">90€</td>
                                <td><input type="number" class="montant-input" data-budget="90" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Scolaire</td>
                                <td class="montant-display">180€</td>
                                <td><input type="number" class="montant-input" data-budget="180" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Sports/Loisirs enfants</td>
                                <td class="montant-display">280€</td>
                                <td><input type="number" class="montant-input" data-budget="280" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Santé courante</td>
                                <td class="montant-display">80€</td>
                                <td><input type="number" class="montant-input" data-budget="80" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Transport abonnements</td>
                                <td class="montant-display">40€</td>
                                <td><input type="number" class="montant-input" data-budget="40" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL CHARGES FIXES</strong></td>
                                <td class="montant-display"><strong>2 210€</strong></td>
                                <td class="montant-display" id="total-fixes-realise"><strong>0€</strong></td>
                                <td class="montant-display" id="total-fixes-ecart"><strong>0€</strong></td>
                                <td class="pourcentage" id="total-fixes-pct"><strong>0%</strong></td>
                                <td class="indicateur" id="total-fixes-indicateur">⚪</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CHARGES VARIABLES -->
            <div class="section">
                <div class="section-header charges-variables">Charges variables</div>
                <div class="table-container">
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Catégorie</th>
                                <th style="width: 15%;">Budget</th>
                                <th style="width: 15%;">Réalisé</th>
                                <th style="width: 15%;">Écart</th>
                                <th style="width: 10%;">%</th>
                                <th style="width: 5%;">📊</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Alimentation maison</td>
                                <td class="montant-display">1 200€</td>
                                <td><input type="number" class="montant-input" data-budget="1200" data-category="charges" data-critical="true" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Resto/Take away</td>
                                <td class="montant-display">120€</td>
                                <td><input type="number" class="montant-input" data-budget="120" data-category="charges" data-critical="true" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Transport ponctuel</td>
                                <td class="montant-display">150€</td>
                                <td><input type="number" class="montant-input" data-budget="150" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Consommation/Plaisir</td>
                                <td class="montant-display">260€</td>
                                <td><input type="number" class="montant-input" data-budget="260" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Provision vacances</td>
                                <td class="montant-display">300€</td>
                                <td><input type="number" class="montant-input" data-budget="300" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr>
                                <td>Provision travaux/imprevus</td>
                                <td class="montant-display">160€</td>
                                <td><input type="number" class="montant-input" data-budget="160" data-category="charges" onchange="calculer()"></td>
                                <td class="montant-display ecart">0€</td>
                                <td class="pourcentage">0%</td>
                                <td class="indicateur">⚪</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTAL CHARGES VARIABLES</strong></td>
                                <td class="montant-display"><strong>2 190€</strong></td>
                                <td class="montant-display" id="total-variables-realise"><strong>0€</strong></td>
                                <td class="montant-display" id="total-variables-ecart"><strong>0€</strong></td>
                                <td class="pourcentage" id="total-variables-pct"><strong>0%</strong></td>
                                <td class="indicateur" id="total-variables-indicateur">⚪</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BILAN -->
            <div class="section">
                <div class="section-header bilan">Bilan mensuel</div>
                <div class="table-container">
                    <table class="budget-table">
                        <tbody>
                            <tr class="total-row">
                                <td style="width: 40%;"><strong>TOTAL DÉPENSES</strong></td>
                                <td class="montant-display" style="width: 15%;"><strong>4 400€</strong></td>
                                <td class="montant-display" id="total-depenses-realise" style="width: 15%;"><strong>0€</strong></td>
                                <td class="montant-display" id="total-depenses-ecart" style="width: 15%;"><strong>0€</strong></td>
                                <td class="pourcentage" id="total-depenses-pct" style="width: 10%;"><strong>0%</strong></td>
                                <td class="indicateur" id="total-depenses-indicateur" style="width: 5%;">⚪</td>
                            </tr>
                            <tr class="solde-row">
                                <td><strong>SOLDE MENSUEL</strong></td>
                                <td class="montant-display"><strong>0€</strong></td>
                                <td class="montant-display" id="solde-realise"><strong>0€</strong></td>
                                <td class="montant-display" id="solde-ecart"><strong>0€</strong></td>
                                <td class="pourcentage" id="solde-pct"><strong>0%</strong></td>
                                <td class="indicateur" id="solde-indicateur" style="font-size: 30px;">⚪</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="alertes" id="alertes">
                <h3 style="color: #c53030; margin-bottom: 15px;">Alertes budgétaires</h3>
                <div id="alertes-contenu"></div>
            </div>
        </div>
    </div>

    <script>
        // Ajouter une dépense via la saisie rapide
        function ajouterDepense() {
            const categorieSelect = document.getElementById('categorie-rapide');
            const montantInput = document.getElementById('montant-rapide');
            const messageDiv = document.getElementById('message-rapide');
            
            const categorie = categorieSelect.value;
            const montant = parseFloat(montantInput.value);
            
            // Validation
            if (!categorie) {
                messageDiv.textContent = 'Veuillez choisir une catégorie';
                messageDiv.style.color = '#e53e3e';
                return;
            }
            
            if (!montant || montant <= 0) {
                messageDiv.textContent = 'Veuillez saisir un montant valide';
                messageDiv.style.color = '#e53e3e';
                return;
            }
            
            // Mapping des catégories avec les champs du tableau (nouveau système)
            const mapping = {
                'logement': 3,          // Logement complet
                'energie': 4,           // Énergie
                'telephonie': 5,        // Téléphonie/Internet
                'banque': 6,            // Banque/Impôts
                'scolaire': 7,          // Scolaire
                'sports': 8,            // Sports/Loisirs enfants
                'sante': 9,             // Santé courante
                'transport-abo': 10,    // Transport abonnements
                'alimentation': 11,     // Alimentation maison
                'resto': 12,            // Resto/Take away
                'transport': 13,        // Transport ponctuel
                'consommation': 14,     // Consommation/Plaisir
                'vacances': 15,         // Provision vacances
                'travaux': 16           // Provision travaux/imprevus
            };
            
            const inputIndex = mapping[categorie];
            if (inputIndex !== undefined) {
                const inputs = document.querySelectorAll('.montant-input');
                const targetInput = inputs[inputIndex];
                
                // Ajouter au montant existant
                const montantExistant = parseFloat(targetInput.value) || 0;
                const nouveauMontant = montantExistant + montant;
                targetInput.value = nouveauMontant;
                
                // Recalculer
                calculer();
                
                // Message de confirmation
                const nomCategorie = categorieSelect.options[categorieSelect.selectedIndex].text;
                messageDiv.textContent = `+${montant}€ ajouté à ${nomCategorie}`;
                messageDiv.style.color = '#38a169';
                
                // Reset du formulaire
                montantInput.value = '';
                categorieSelect.selectedIndex = 0;
                
                // Effacer le message après 3 secondes
                setTimeout(() => {
                    messageDiv.textContent = '';
                }, 3000);
            }
        }

        // Afficher un message de statut
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }

        // Sauvegarder dans Google Sheets
        async function sauvegarderCloud() {
            const mois = document.getElementById('mois').value.trim();
            const annee = document.getElementById('annee').value.trim();
            
            if (!mois || !annee) {
                showStatus('Veuillez renseigner le mois et l\'année', 'error');
                return;
            }
            
            // Collecter toutes les données
            const donnees = [];
            document.querySelectorAll('.montant-input').forEach(input => {
                donnees.push(parseFloat(input.value) || 0);
            });
            
            // Désactiver le bouton pendant la sauvegarde
            const btnSauv = document.getElementById('btn-sauv');
            btnSauv.disabled = true;
            showStatus('Sauvegarde en cours...', 'loading');
            
            try {
                // Créer l'URL avec les paramètres
                const params = new URLSearchParams({
                    action: 'sauvegarder',
                    mois: mois,
                    annee: parseInt(annee),
                    donnees: JSON.stringify(donnees)
                });
                
                const url = `${API_URL}?${params.toString()}`;
                
                // Utiliser une iframe cachée pour contourner CORS
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                iframe.onload = function() {
                    showStatus('Données sauvegardées avec succès', 'success');
                    setTimeout(() => {
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    }, 1000);
                };
                
                iframe.onerror = function() {
                    showStatus('Erreur de sauvegarde', 'error');
                    setTimeout(() => {
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    }, 1000);
                };
                
                iframe.src = url;
                
            } catch (error) {
                showStatus(`Erreur: ${error.message}`, 'error');
            }
            
            btnSauv.disabled = false;
        }

        // Charger depuis Google Sheets
        async function chargerCloud() {
            const mois = document.getElementById('mois').value.trim();
            const annee = document.getElementById('annee').value.trim();
            
            if (!mois || !annee) {
                showStatus('Veuillez renseigner le mois et l\'année', 'error');
                return;
            }
            
            const btnLoad = document.getElementById('btn-load');
            btnLoad.disabled = true;
            showStatus('Chargement en cours...', 'loading');
            
            try {
                // Créer un script tag pour JSONP
                const script = document.createElement('script');
                const callbackName = 'budgetCallback' + Date.now();
                
                // Créer la fonction callback
                window[callbackName] = function(result) {
                    try {
                        if (result && result.success) {
                            // Mapper les données aux champs (nouvelles catégories)
                            const categories = [
                                "Salaire Marie", "Salaire Etienne", "CAF",
                                "Logement", "Énergie", "Téléphonie/Internet", 
                                "Banque/Impôts", "Scolaire", "Sports/Loisirs", "Santé", "Transport abonnements",
                                "Alimentation", "Resto/Take away", "Transport ponctuel",
                                "Consommation/Plaisir", "Provision vacances", "Provision travaux"
                            ];
                            
                            document.querySelectorAll('.montant-input').forEach((input, index) => {
                                const categorie = categories[index];
                                input.value = result.data[categorie] || '';
                            });
                            
                            calculer();
                            showStatus(`Données chargées (${result.count || 0} éléments)`, 'success');
                        } else {
                            showStatus('Aucune donnée trouvée pour ce mois', 'error');
                        }
                    } catch (e) {
                        showStatus('Erreur lors du traitement des données', 'error');
                    }
                    
                    // Nettoyer
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // Construire l'URL JSONP
                const params = new URLSearchParams({
                    action: 'charger',
                    mois: mois,
                    annee: parseInt(annee),
                    callback: callbackName
                });
                
                script.src = `${API_URL}?${params.toString()}`;
                script.onerror = function() {
                    showStatus('Erreur de chargement', 'error');
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                document.body.appendChild(script);
                
            } catch (error) {
                showStatus(`Erreur: ${error.message}`, 'error');
            }
            
            btnLoad.disabled = false;
        }

        // Reset complet
        function reset() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données saisies ?')) {
                document.querySelectorAll('.montant-input').forEach(input => {
                    input.value = '';
                });
                calculer();
                showStatus('Données effacées !', 'success');
            }
        }

        // Calculer tous les totaux et pourcentages
        function calculer() {
            let totalRevenusRealise = 0;
            let totalFixesRealise = 0;
            let totalVariablesRealise = 0;
            let alertes = [];

            document.querySelectorAll('.montant-input').forEach(input => {
                const budget = parseFloat(input.dataset.budget) || 0;
                const realise = parseFloat(input.value) || 0;
                const category = input.dataset.category;
                const critical = input.dataset.critical === 'true';
                
                const ecart = realise - budget;
                const pourcentage = budget > 0 ? (realise / budget) * 100 : 0;
                
                const row = input.closest('tr');
                row.querySelector('.ecart').textContent = ecart >= 0 ? `+${ecart}€` : `${ecart}€`;
                
                const pctCell = row.querySelector('.pourcentage');
                const indicateur = row.querySelector('.indicateur');
                
                pctCell.textContent = `${Math.round(pourcentage)}%`;
                
                // Logique différente pour revenus vs dépenses
                if (category === 'revenus') {
                    if (pourcentage === 0) {
                        pctCell.className = 'pourcentage';
                        indicateur.textContent = '⚪';
                    } else if (pourcentage < 90) {
                        pctCell.className = 'pourcentage rouge';
                        indicateur.textContent = '❌';
                    } else if (pourcentage < 100) {
                        pctCell.className = 'pourcentage orange';
                        indicateur.textContent = '⚠️';
                    } else {
                        pctCell.className = 'pourcentage vert';
                        indicateur.textContent = '✅';
                    }
                } else {
                    if (pourcentage === 0) {
                        pctCell.className = 'pourcentage';
                        indicateur.textContent = '⚪';
                    } else if (pourcentage < 100) {
                        pctCell.className = 'pourcentage vert';
                        indicateur.textContent = '✅';
                    } else if (pourcentage <= 110) {
                        pctCell.className = 'pourcentage orange';
                        indicateur.textContent = '⚠️';
                    } else {
                        pctCell.className = 'pourcentage rouge';
                        indicateur.textContent = '❌';
                    }
                }

                // Alertes pour les postes critiques
                if (critical && category === 'charges' && pourcentage > 75) {
                    const categorieName = row.querySelector('td').textContent;
                    if (pourcentage > 110) {
                        alertes.push(`DÉPASSEMENT CRITIQUE: ${categorieName} (${Math.round(pourcentage)}%)`);
                    } else if (pourcentage > 100) {
                        alertes.push(`BUDGET DÉPASSÉ: ${categorieName} (${Math.round(pourcentage)}%)`);
                    } else if (pourcentage > 75) {
                        alertes.push(`ATTENTION: ${categorieName} à ${Math.round(pourcentage)}% - Ralentir !`);
                    }
                }

                // Alertes pour les revenus manquants
                if (category === 'revenus' && pourcentage < 90 && pourcentage > 0) {
                    const categorieName = row.querySelector('td').textContent;
                    alertes.push(`REVENUS INCOMPLETS: ${categorieName} seulement à ${Math.round(pourcentage)}%`);
                }

                // Cumuls par catégorie
                if (category === 'revenus') {
                    totalRevenusRealise += realise;
                } else if (category === 'charges') {
                    const tableSection = input.closest('.section');
                    if (tableSection.querySelector('.charges-fixes')) {
                        totalFixesRealise += realise;
                    } else {
                        totalVariablesRealise += realise;
                    }
                }
            });

            // Mise à jour des totaux
            updateTotal('total-revenus', 4400, totalRevenusRealise, 'revenus');
            updateTotal('total-fixes', 2210, totalFixesRealise, 'charges');
            updateTotal('total-variables', 2190, totalVariablesRealise, 'charges');
            
            const totalDepensesRealise = totalFixesRealise + totalVariablesRealise;
            updateTotal('total-depenses', 4400, totalDepensesRealise, 'charges');
            
            // Solde
            const soldeRealise = totalRevenusRealise - totalDepensesRealise;
            const soldeEcart = soldeRealise - 200;
            const soldePct = totalRevenusRealise > 0 ? (soldeRealise / totalRevenusRealise) * 100 : 0;
            
            document.getElementById('solde-realise').innerHTML = `<strong>${soldeRealise >= 0 ? '+' : ''}${soldeRealise}€</strong>`;
            document.getElementById('solde-ecart').innerHTML = `<strong>${soldeEcart >= 0 ? '+' : ''}${soldeEcart}€</strong>`;
            document.getElementById('solde-pct').innerHTML = `<strong>${Math.round(soldePct)}%</strong>`;
            
            const soldeIndicateur = document.getElementById('solde-indicateur');
            const soldeRow = soldeIndicateur.closest('tr');
            
            if (soldeRealise > 0) {
                soldeIndicateur.textContent = '🎉';
                soldeRow.className = 'solde-row solde-positif';
            } else if (soldeRealise === 0) {
                soldeIndicateur.textContent = '⚖️';
                soldeRow.className = 'solde-row';
            } else {
                soldeIndicateur.textContent = '💸';
                soldeRow.className = 'solde-row solde-negatif';
                alertes.unshift(`SOLDE NÉGATIF: ${soldeRealise}€ - DÉSÉPARGNE EN COURS !`);
            }

            // Affichage des alertes
            const alertesDiv = document.getElementById('alertes');
            const alertesContenu = document.getElementById('alertes-contenu');
            
            if (alertes.length > 0) {
                alertesContenu.innerHTML = alertes.map(alerte => `<div class="alerte-item">${alerte}</div>`).join('');
                alertesDiv.classList.add('show');
            } else {
                alertesDiv.classList.remove('show');
            }
        }

        function updateTotal(prefix, budget, realise, category = 'charges') {
            const ecart = realise - budget;
            const pourcentage = budget > 0 ? (realise / budget) * 100 : 0;
            
            document.getElementById(`${prefix}-realise`).innerHTML = `<strong>${realise}€</strong>`;
            document.getElementById(`${prefix}-ecart`).innerHTML = `<strong>${ecart >= 0 ? '+' : ''}${ecart}€</strong>`;
            
            const pctElement = document.getElementById(`${prefix}-pct`);
            const indicateurElement = document.getElementById(`${prefix}-indicateur`);
            
            pctElement.innerHTML = `<strong>${Math.round(pourcentage)}%</strong>`;
            
            if (category === 'revenus') {
                if (pourcentage === 0) {
                    pctElement.className = 'pourcentage';
                    indicateurElement.textContent = '⚪';
                } else if (pourcentage < 90) {
                    pctElement.className = 'pourcentage rouge';
                    indicateurElement.textContent = '❌';
                } else if (pourcentage < 100) {
                    pctElement.className = 'pourcentage orange';
                    indicateurElement.textContent = '⚠️';
                } else {
                    pctElement.className = 'pourcentage vert';
                    indicateurElement.textContent = '✅';
                }
            } else {
                if (pourcentage === 0) {
                    pctElement.className = 'pourcentage';
                    indicateurElement.textContent = '⚪';
                } else if (pourcentage < 100) {
                    pctElement.className = 'pourcentage vert';
                    indicateurElement.textContent = '✅';
                } else if (pourcentage <= 110) {
                    pctElement.className = 'pourcentage orange';
                    indicateurElement.textContent = '⚠️';
                } else {
                    pctElement.className = 'pourcentage rouge';
                    indicateurElement.textContent = '❌';
                }
            }
        }

        // Calcul initial au chargement
        window.addEventListener('load', function() {
            // Définir l'année en cours automatiquement
            document.getElementById('annee').value = new Date().getFullYear();
            
            // Définir le mois en cours automatiquement
            const moisActuel = new Date().getMonth(); // 0 = janvier, 1 = février, etc.
            const noms_mois = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", 
                              "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            document.getElementById('mois').value = noms_mois[moisActuel];
            
            // Ajouter les event listeners pour les calculs
            document.querySelectorAll('.montant-input').forEach(input => {
                input.addEventListener('change', calculer);
                input.addEventListener('input', calculer);
            });
            
            // Charger automatiquement les données du mois en cours
            setTimeout(() => {
                chargerCloud();
            }, 1000);
            
            calculer();
        });

        // Permettre l'ajout avec la touche Entrée
        document.addEventListener('DOMContentLoaded', function() {
            const montantInput = document.getElementById('montant-rapide');
            if (montantInput) {
                montantInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        ajouterDepense();
                    }
                });
            }
        });

        calculer();
    </script>
</body>
</html>
